<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"/>
<link rel="import" href="../../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">

<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">


<script src="../../bower_components/d3/d3.min.js"></script>
<script src="../../bower_components/underscore/underscore-min.js"></script>
<script src="../../scripts/radarChart.js"></script>

<dom-module id="my-emotion">
  <template>
    <style include="shared-styles iron-flex">
      /*paper-slider {*/
      /*width: 100%;*/
      /*}*/

      paper-slider {
        /*width: flex;*/
        /*height: 500px;*/
        margin: 13vh -10vh;
        --webkit-transform: rotate(90deg);
        transform: rotate(90deg);
      }

      .legend {
        font-family: 'Raleway', sans-serif;
        fill: #333333;
      }

      .tooltip {
        fill: #333333;
      }

      #emoContent {
        margin-top: 20px;
      }
    </style>

    <paper-textarea label="Please enter your text here. Click the button below to convert your text."
                    value="{{searchCriterion2}}"
                    char-counter maxlength="1000"></paper-textarea>

    <div style="text-align:center;">
      <paper-button raised on-click="convertToEmotion">Analyze</paper-button>
    </div>

    <div id="emoContent" class="layout horizontal">
      <div id="radarChart"></div>

      <div  class="layout vertical center flex">

        <iron-image alt="Sad" style="width:70px; height:70px;" sizing="contain"
                    src="../../images/sad.jpg"></iron-image>
        <paper-slider id="sentimentSlider"  pin="true" step="0.01" snaps="false" min=0 max=1
                      value="{{sentiments.positive}}f"></paper-slider>
        <iron-image alt="Happy" style="width:70px; height:70px;" sizing="contain"
                    src="../../images/happy.png"></iron-image>
      </div>

    </div>
    <iron-ajax id="emotion"
               url="http://augment.cs.kuleuven.be/paris/api/emotion"
               method="POST" 
               handle-as="json"
               content-type="text/plain"
               last-response="{{data}}"
               params="{{ajaxParams}}"
               on-response="responseHandler"
               on-error="handleError"></iron-ajax>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'my-emotion',

        properties: {
          ajaxParams: {
            type: String,
            computed: 'buildSearchRequest(searchCriterion2)'
          }
        },

        _getHeight: function (element) {
          console.log(element.offsetHeight);
        },

        ready: function () {

//          this.scopeSubtree(this.$.radarChart, true);

          this.title = "Emotion";
          this.emotions = {anticipation: 0, joy: 0, sadness: 0, disgust: 0, anger: 0, surprise: 0, fear: 0, trust: 0};
          this.sentiments = {positive: 0, negative: 0};



          //////////////////////////////////////////////////////////////
          //////////////////////// Set-Up //////////////////////////////
          //////////////////////////////////////////////////////////////

          this.margin = {top: 20, right: 10, bottom: 20, left: 10},
            this.width = Math.min(700, window.innerWidth - 10) - this.margin.left - this.margin.right,
            this.height = 300;//Math.min(this.width, window.innerHeight - this.margin.top - this.margin.bottom - 20);

          //////////////////////////////////////////////////////////////
          ////////////////////////// Data //////////////////////////////
          //////////////////////////////////////////////////////////////

          this.data = [[]];

          for (var key in this.emotions) {
            if (this.emotions.hasOwnProperty(key)) {
              var val = this.emotions[key];
              this.data[0].push({axis: key, value: val})
            }
          }

          //////////////////////////////////////////////////////////////
          //////////////////// Draw the Chart //////////////////////////
          //////////////////////////////////////////////////////////////

          this.color = d3.scale.ordinal()
            .range(["#EDC951", "#CC333F", "#00A0B0"]);

          this.radarChartOptions = {
            w: this.width,
            h: this.height,
            margin: this.margin,
            maxValue: 0.5,
            levels: 5,
            roundStrokes: true,
            color: this.color
          };
          //Call function to draw the Radar chart
          RadarChart(this.$.radarChart, this.data, this.radarChartOptions);


          var slider = this.$.sentimentSlider;
          slider._trackX = function(e) {

            if (!slider.dragging) {
              slider._trackStart(e);
            }

            var dx = Math.min(slider._maxx, Math.max(slider._minx, (-1 * e.detail.dy)));
            slider._x = slider._startx + dx;

            var immediateValue = slider._calcStep(slider._calcKnobPosition(slider._x / slider._w));
            slider._setImmediateValue(immediateValue);

            // update knob's position
            var translateY = ((slider._calcRatio(immediateValue) * slider._w) - slider._startx);
            slider.translate3d(translateY + 'px', 0, 0, slider.$.sliderKnob);
          };

          slider._bardown = function(event) {
            slider._w = slider.$.sliderBar.offsetWidth;
            var rect = slider.$.sliderBar.getBoundingClientRect();
            var ratio = ((rect.bottom - event.detail.y) / slider._w);
            var prevRatio = slider.ratio;

            slider._setTransiting(true);

            slider._positionKnob(ratio);

            slider.debounce('expandKnob', slider._expandKnob, 60);

            // if the ratio doesn't change, sliderKnob's animation won't start
            // and `_knobTransitionEnd` won't be called
            // Therefore, we need to manually update the `transiting` state

            if (prevRatio === slider.ratio) {
              slider._setTransiting(false);
            }

            slider.async(function() {
              slider.fire('change');
            });

            // cancel selection
            event.preventDefault();
          }

        },

        buildSearchRequest: function (searchCriterion2) {
          this.$.emotion.body = searchCriterion2;
        },

        convertToEmotion: function () {
          this.$.emotion.generateRequest();
        },

        handleError: function (e) {
          alert('Whoops! ' + e.detail.error + " See console for more detailed error message.");
          console.log(e.detail);
        },

        responseHandler: function (e, detail) {
          this.emotionJSON = detail.xhr.response.emotion;
          this.sentiments = detail.xhr.response.sentiment;
          for (var p in this.emotionJSON) {
            this.emotionJSON[p] = this.emotionJSON[p].toFixed(3);
          }
          this.emotions = this.emotionJSON;
          this.data = [[]];

          for (var key in this.emotions) {
            if (this.emotions.hasOwnProperty(key)) {
              var val = this.emotions[key];
              this.data[0].push({axis: key, value: val})
            }
          }
          RadarChart(this.$.radarChart, this.data, this.radarChartOptions);
        }


      });
    })();
  </script>
</dom-module>
